<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedStock Manager</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#b45309', // amber-700
                        secondary: '#78350f', // amber-900
                        accent: '#f59e0b', // amber-500
                        bg: '#f5f5f4', // stone-100
                        surface: '#ffffff',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4;
            color: #44403c;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e7e5e4;
        }

        ::-webkit-scrollbar-thumb {
            background: #a8a29e;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #78716c;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            .print-content,
            .print-content * {
                visibility: visible;
            }

            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                z-index: 9999;
            }

            .no-print {
                display: none !important;
            }

            /* Reset body background for cleaner print */
            body {
                background: white;
                overflow: hidden;
                /* Prevent scrollbars in print */
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons Components ---
        const Icon = ({ path, className = "w-5 h-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            LayoutDashboard: <Icon path={<><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></>} />,
            Package: <Icon path={<><path d="m7.5 4.27 9 5.15" /><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" /><path d="m3.3 7 8.7 5 8.7-5" /><path d="M12 22v-9" /></>} />,
            MapPin: <Icon path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></>} />,
            ShoppingCart: <Icon path={<><circle cx="8" cy="21" r="1" /><circle cx="19" cy="21" r="1" /><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12" /></>} />,
            History: <Icon path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /><path d="M12 7v5l3 3" /></>} />,
            Settings: <Icon path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1-1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></>} />,
            Trash2: <Icon path={<><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>} />,
            Download: <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>} />,
            Upload: <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>} />,
            Plus: <Icon path={<><path d="M5 12h14" /><path d="M12 5v14" /></>} />,
            Tag: <Icon path={<><path d="M12 2H2v10l9.29 9.29a2.5 2.5 0 0 0 3.54 0l4.58-4.58a2.5 2.5 0 0 0 0-3.54L12 2Z" /><circle cx="7" cy="7" r="2" /></>} />,
            Printer: <Icon path={<><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>} />,
            AlertTriangle: <Icon path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></>} />,
            TrendingUp: <Icon path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>} />,
            X: <Icon path={<><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>} />,
            Menu: <Icon path={<><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>} />,
        };

        // --- Utils ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatMoney = (amount) => `₹${Number(amount).toLocaleString('en-IN')}`;

        const formatDateDisplay = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        // --- Helper function for URL hash-based navigation ---
        const getInitialView = () => {
            const hash = window.location.hash.slice(1); // Remove '#'
            const validViews = ['dashboard', 'inventory', 'destinations', 'transaction', 'history', 'settings'];
            return validViews.includes(hash) ? hash : 'dashboard';
        };

        // --- Main App Component ---
        function App() {
            // --- State ---
            const [view, setView] = useState(getInitialView);
            const [inventory, setInventory] = useState([]);
            const [destinations, setDestinations] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [labels, setLabels] = useState(['Paid', 'Not Paid', 'Received', 'Pending']);
            const [notification, setNotification] = useState(null);
            const [printInvoiceId, setPrintInvoiceId] = useState(null);
            const [showMonthlyReportModal, setShowMonthlyReportModal] = useState(false);
            const [monthlyReportData, setMonthlyReportData] = useState({ destinationId: '', month: '', year: '' });
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

            // --- Load/Save Data ---
            useEffect(() => {
                const loadedData = localStorage.getItem('medStockData');
                if (loadedData) {
                    try {
                        const parsed = JSON.parse(loadedData);
                        setInventory(parsed.inventory || []);
                        setDestinations(parsed.destinations || []);
                        setTransactions(parsed.transactions || []);
                        setLabels(parsed.labels || ['Paid', 'Not Paid', 'Received', 'Pending']);
                    } catch (e) {
                        console.error("Failed to load data", e);
                    }
                }
            }, []);

            // --- URL Hash Navigation ---
            // Update URL hash when view changes
            useEffect(() => {
                if (window.location.hash.slice(1) !== view) {
                    window.history.pushState(null, '', `#${view}`);
                }
            }, [view]);

            // Listen for browser back/forward buttons
            useEffect(() => {
                const handlePopState = () => {
                    const hash = window.location.hash.slice(1);
                    const validViews = ['dashboard', 'inventory', 'destinations', 'transaction', 'history', 'settings'];
                    if (validViews.includes(hash) && hash !== view) {
                        setView(hash);
                    }
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [view]);

            useEffect(() => {
                const data = { inventory, destinations, transactions, labels };
                localStorage.setItem('medStockData', JSON.stringify(data));
            }, [inventory, destinations, transactions, labels]);

            const showNotification = (msg, type = 'success', undoAction = null) => {
                setNotification({ msg, type, undoAction });
                setTimeout(() => setNotification(null), 5000);
            };

            // --- Actions ---
            const addStock = (item) => {
                setInventory([...inventory, { ...item, id: generateId() }]);
                showNotification(`Added ${item.name} to stock`);
            };

            const updateStock = (id, updatedItem) => {
                setInventory(inventory.map(item => item.id === id ? { ...item, ...updatedItem } : item));
                showNotification(`Updated stock details`);
            };

            const updateTransactionStatus = (id, newStatus) => {
                setTransactions(transactions.map(t =>
                    t.id === id ? { ...t, label: newStatus } : t
                ));
                showNotification(`Status updated to ${newStatus}`);
            };

            const deleteTransaction = (id) => {
                const transactionToDelete = transactions.find(t => t.id === id);
                if (!transactionToDelete) return;

                // Restore inventory quantity
                const stockItem = inventory.find(i => i.id === transactionToDelete.stockId);
                if (stockItem) {
                    setInventory(inventory.map(item =>
                        item.id === transactionToDelete.stockId
                            ? { ...item, quantity: item.quantity + transactionToDelete.quantity }
                            : item
                    ));
                }

                setTransactions(transactions.filter(t => t.id !== id));
                showNotification(
                    `Deleted transaction for ${transactionToDelete.stockName}`,
                    'neutral',
                    () => {
                        // Undo: restore transaction and reduce inventory again
                        setTransactions(prev => [...prev, transactionToDelete]);
                        if (stockItem) {
                            setInventory(prev => prev.map(item =>
                                item.id === transactionToDelete.stockId
                                    ? { ...item, quantity: item.quantity - transactionToDelete.quantity }
                                    : item
                            ));
                        }
                        showNotification(`Restored transaction for ${transactionToDelete.stockName}`);
                    }
                );
            };

            const updateTransaction = (id, updatedData) => {
                const oldTransaction = transactions.find(t => t.id === id);
                if (!oldTransaction) return;

                // Calculate new amounts
                const newTotalAmount = updatedData.sellingPrice * updatedData.quantity;
                const newProfit = (updatedData.sellingPrice - updatedData.costPrice) * updatedData.quantity;

                // Update inventory if quantity changed
                const quantityDiff = oldTransaction.quantity - updatedData.quantity;
                if (quantityDiff !== 0) {
                    setInventory(inventory.map(item =>
                        item.id === oldTransaction.stockId
                            ? { ...item, quantity: item.quantity + quantityDiff }
                            : item
                    ));
                }

                setTransactions(transactions.map(t =>
                    t.id === id ? {
                        ...t,
                        ...updatedData,
                        totalAmount: newTotalAmount,
                        profit: newProfit
                    } : t
                ));
                showNotification('Transaction updated successfully');
            };

            const deleteStock = (id) => {
                const itemToDelete = inventory.find(i => i.id === id);
                if (!itemToDelete) return;
                setInventory(inventory.filter(item => item.id !== id));
                showNotification(
                    `Deleted ${itemToDelete.name}`,
                    'neutral',
                    () => {
                        setInventory(prev => [...prev, itemToDelete]);
                        showNotification(`Restored ${itemToDelete.name}`);
                    }
                );
            };

            const addDestination = (name) => {
                if (!name.trim()) return;
                setDestinations([...destinations, { id: generateId(), name }]);
                showNotification('Destination added');
            };

            const removeDestination = (id) => {
                setDestinations(destinations.filter(d => d.id !== id));
            };

            const addLabel = (name) => {
                if (!name.trim() || labels.includes(name)) return;
                setLabels([...labels, name]);
                showNotification('Label added');
            };

            const removeLabel = (name) => {
                setLabels(labels.filter(l => l !== name));
            };

            const processCartTransaction = (cart, commonData) => {
                const { destinationId, label, date } = commonData;
                const dest = destinations.find(d => d.id === destinationId);
                const invoiceId = generateId(); // Unique ID for this batch

                const newTransactions = [];
                const inventoryUpdates = new Map();

                // Prepare updates
                cart.forEach(item => {
                    const currentQty = inventoryUpdates.has(item.stockId)
                        ? inventoryUpdates.get(item.stockId)
                        : inventory.find(i => i.id === item.stockId).quantity;

                    inventoryUpdates.set(item.stockId, currentQty - item.quantity);

                    newTransactions.push({
                        id: generateId(),
                        invoiceId,
                        date: date || new Date().toISOString(),
                        stockId: item.stockId,
                        stockName: item.stockName,
                        quantity: Number(item.quantity),
                        costPrice: Number(item.costPrice),
                        sellingPrice: Number(item.sellingPrice),
                        totalAmount: item.totalAmount,
                        profit: item.profit,
                        destinationId,
                        destinationName: dest ? dest.name : 'Unknown',
                        label
                    });
                });

                // Apply updates
                const updatedInventory = inventory.map(item => {
                    if (inventoryUpdates.has(item.id)) {
                        return { ...item, quantity: inventoryUpdates.get(item.id) };
                    }
                    return item;
                });

                setTransactions([...newTransactions, ...transactions]);
                setInventory(updatedInventory);
                showNotification(`Successfully recorded ${cart.length} items!`);
                setView('history');
            };

            const clearData = (type) => {
                if (!confirm(`Are you sure you want to delete ALL ${type}? This cannot be undone.`)) return;

                if (type === 'Inventory') setInventory([]);
                if (type === 'History') setTransactions([]);
                if (type === 'Everything') {
                    setInventory([]);
                    setTransactions([]);
                    setDestinations([]);
                    setLabels(['Paid', 'Not Paid', 'Received', 'Pending']);
                }
                showNotification(`${type} cleared successfully.`);
            };

            // --- Sub-components (Views) ---

            const InvoiceModal = ({ invoiceId, onClose }) => {
                const transactionsForInvoice = useMemo(() => {
                    if (!invoiceId) return [];
                    return transactions.filter(t => t.invoiceId === invoiceId);
                }, [invoiceId, transactions]);

                if (!invoiceId || transactionsForInvoice.length === 0) return null;

                const firstTransaction = transactionsForInvoice[0]; // Use first transaction for common details like destination, date, label
                const invoiceTotal = transactionsForInvoice.reduce((acc, item) => acc + item.totalAmount, 0);

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                        {/* Wrapper logic: no-print removed, using print-content class on the inner div */}
                        <div className="bg-white w-full max-w-2xl p-8 rounded-lg shadow-xl relative animate-fadeIn print-content" id="invoice-modal">

                            <div className="border-b-2 border-amber-200 pb-4 mb-6">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h1 className="text-3xl font-bold text-amber-900">INVOICE</h1>
                                        <p className="text-stone-500">#{firstTransaction.invoiceId.toUpperCase().substring(0, 8)}</p>
                                    </div>
                                    <div className="text-right">
                                        <h2 className="text-xl font-bold text-amber-600">MedStock Manager</h2>
                                        <p className="text-stone-500 text-sm">Automated Stock System</p>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-8 mb-8">
                                <div>
                                    <h3 className="font-bold text-stone-700 mb-2">Billed To:</h3>
                                    <p className="text-lg">{firstTransaction.destinationName}</p>
                                    <p className="text-sm text-stone-500 mt-1">Status: <span className="font-bold">{firstTransaction.label}</span></p>
                                </div>
                                <div className="text-right">
                                    <h3 className="font-bold text-stone-700 mb-2">Date:</h3>
                                    <p>{formatDateDisplay(firstTransaction.date)}</p>
                                </div>
                            </div>

                            <table className="w-full mb-8">
                                <thead className="bg-amber-50">
                                    <tr>
                                        <th className="px-4 py-2 text-left text-amber-900">Item Description</th>
                                        <th className="px-4 py-2 text-right text-amber-900">Quantity</th>
                                        <th className="px-4 py-2 text-right text-amber-900">Unit Price</th>
                                        <th className="px-4 py-2 text-right text-amber-900">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {transactionsForInvoice.map(item => (
                                        <tr key={item.id} className="border-b border-amber-100">
                                            <td className="px-4 py-3">{item.stockName}</td>
                                            <td className="px-4 py-3 text-right">{item.quantity}</td>
                                            <td className="px-4 py-3 text-right">{formatMoney(item.sellingPrice)}</td>
                                            <td className="px-4 py-3 text-right font-bold">{formatMoney(item.totalAmount)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            <div className="flex justify-end mb-8">
                                <div className="text-right w-1/2">
                                    <div className="flex justify-between border-t border-stone-300 pt-2 text-xl font-bold text-stone-800">
                                        <span>Total:</span>
                                        <span>{formatMoney(invoiceTotal)}</span>
                                    </div>
                                </div>
                            </div>

                            <div className="text-center text-stone-400 text-sm mt-12 pt-4 border-t">
                                <p>Thank you for your business!</p>
                            </div>

                            <div className="absolute top-4 right-4 flex gap-2 no-print">
                                <button onClick={() => window.print()} className="bg-amber-600 text-white px-4 py-2 rounded shadow hover:bg-amber-700 flex items-center gap-2">
                                    {Icons.Printer} Print
                                </button>
                                <button onClick={onClose} className="bg-stone-200 text-stone-700 px-4 py-2 rounded hover:bg-stone-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const MonthlyReportModal = ({ show, onClose, destinationId, month, year }) => {
                const reportTransactions = useMemo(() => {
                    if (!show || !destinationId || month === '' || year === '') return [];
                    return transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return t.destinationId === destinationId &&
                            transactionDate.getMonth() === parseInt(month) &&
                            transactionDate.getFullYear() === parseInt(year);
                    });
                }, [show, destinationId, month, year, transactions]);

                const destinationName = useMemo(() => {
                    const dest = destinations.find(d => d.id === destinationId);
                    return dest ? dest.name : 'Unknown Destination';
                }, [destinationId, destinations]);

                const reportTotals = useMemo(() => {
                    return reportTransactions.reduce((acc, t) => {
                        acc.totalItems += t.quantity;
                        acc.totalCostPrice += t.costPrice * t.quantity;
                        acc.totalSellingPrice += t.sellingPrice * t.quantity;
                        acc.totalProfit += t.profit;
                        return acc;
                    }, { totalItems: 0, totalCostPrice: 0, totalSellingPrice: 0, totalProfit: 0 });
                }, [reportTransactions]);

                if (!show) return null;

                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                const displayMonth = monthNames[parseInt(month)];

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                        <div className="bg-white w-full max-w-4xl p-8 rounded-lg shadow-xl relative animate-fadeIn print-content" id="monthly-report-modal">
                            <div className="border-b-2 border-stone-200 pb-4 mb-6">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h1 className="text-3xl font-bold text-stone-800">Monthly Transaction Report</h1>
                                        <p className="text-stone-500">For {displayMonth}, {year}</p>
                                    </div>
                                    <div className="text-right">
                                        <h2 className="text-xl font-bold text-amber-600">MedStock Manager</h2>
                                        <p className="text-stone-500 text-sm">Automated Stock System</p>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-8 mb-8">
                                <div>
                                    <h3 className="font-bold text-stone-700 mb-2">Destination:</h3>
                                    <p className="text-lg">{destinationName}</p>
                                </div>
                                <div className="text-right">
                                    <h3 className="font-bold text-stone-700 mb-2">Report Date:</h3>
                                    <p>{formatDateDisplay(new Date().toISOString())}</p>
                                </div>
                            </div>

                            {reportTransactions.length === 0 ? (
                                <div className="text-center py-12 text-stone-500 text-lg">
                                    No transactions found for {destinationName} in {displayMonth}, {year}.
                                </div>
                            ) : (
                                <table className="w-full mb-8">
                                    <thead className="bg-amber-50">
                                        <tr>
                                            <th className="px-4 py-2 text-left text-amber-900">Date</th>
                                            <th className="px-4 py-2 text-left text-amber-900">Item</th>
                                            <th className="px-4 py-2 text-right text-amber-900">Qty</th>
                                            <th className="px-4 py-2 text-right text-amber-900">CP</th>
                                            <th className="px-4 py-2 text-right text-amber-900">SP</th>
                                            <th className="px-4 py-2 text-right text-amber-900">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {reportTransactions.map(t => (
                                            <tr key={t.id} className="border-b border-amber-100">
                                                <td className="px-4 py-3">{formatDateDisplay(t.date)}</td>
                                                <td className="px-4 py-3">{t.stockName}</td>
                                                <td className="px-4 py-3 text-right">{t.quantity}</td>
                                                <td className="px-4 py-3 text-right">{formatMoney(t.costPrice * t.quantity)}</td>
                                                <td className="px-4 py-3 text-right">{formatMoney(t.sellingPrice * t.quantity)}</td>
                                                <td className="px-4 py-3 text-right font-bold">{formatMoney(t.totalAmount)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr className="bg-amber-100 font-bold text-amber-900">
                                            <td colSpan="2" className="px-4 py-3 text-right">Report Totals:</td>
                                            <td className="px-4 py-3 text-right">{reportTotals.totalItems}</td>
                                            <td className="px-4 py-3 text-right">{formatMoney(reportTotals.totalCostPrice)}</td>
                                            <td className="px-4 py-3 text-right">{formatMoney(reportTotals.totalSellingPrice)}</td>
                                            <td className="px-4 py-3 text-right">{formatMoney(reportTotals.totalProfit)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            )}

                            <div className="text-center text-stone-400 text-sm mt-12 pt-4 border-t">
                                <p>Generated by MedStock Manager</p>
                            </div>

                            <div className="absolute top-4 right-4 flex gap-2 no-print">
                                <button onClick={() => window.print()} className="bg-amber-600 text-white px-4 py-2 rounded shadow hover:bg-amber-700 flex items-center gap-2">
                                    {Icons.Printer} Print Report
                                </button>
                                <button onClick={onClose} className="bg-stone-200 text-stone-700 px-4 py-2 rounded hover:bg-stone-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const Dashboard = () => {
                // Date filter state
                const [dateFilter, setDateFilter] = useState('all'); // 'all', 'week', 'month', 'year', 'custom'
                const [customDateRange, setCustomDateRange] = useState({ start: '', end: '' });

                // Calculate date ranges
                const getDateRange = () => {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                    switch (dateFilter) {
                        case 'week':
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - today.getDay());
                            return { start: weekStart, end: now };
                        case 'month':
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                            return { start: monthStart, end: now };
                        case 'year':
                            const yearStart = new Date(now.getFullYear(), 0, 1);
                            return { start: yearStart, end: now };
                        case 'custom':
                            return {
                                start: customDateRange.start ? new Date(customDateRange.start) : null,
                                end: customDateRange.end ? new Date(customDateRange.end + 'T23:59:59') : null
                            };
                        default:
                            return { start: null, end: null };
                    }
                };

                // Filter transactions by date
                const filteredTransactions = useMemo(() => {
                    const range = getDateRange();
                    if (!range.start && !range.end) return transactions;

                    return transactions.filter(t => {
                        const tDate = new Date(t.date);
                        if (range.start && tDate < range.start) return false;
                        if (range.end && tDate > range.end) return false;
                        return true;
                    });
                }, [transactions, dateFilter, customDateRange]);

                const totalStockValue = inventory.reduce((acc, item) => acc + (item.quantity * item.costPrice), 0);
                const totalRevenue = filteredTransactions.reduce((acc, t) => acc + t.totalAmount, 0);
                const totalProfit = filteredTransactions.reduce((acc, t) => acc + t.profit, 0);
                // Calculate total cost price from transactions
                // For legacy data: if costPrice is missing, derive from sellingPrice - (profit / quantity)
                const totalCostPrice = filteredTransactions.reduce((acc, t) => {
                    const costPricePerUnit = t.costPrice || (t.sellingPrice - (t.profit / t.quantity));
                    return acc + (costPricePerUnit * t.quantity);
                }, 0);

                // Calculate profit margin percentage
                const profitMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) : 0;

                const lowStockItems = inventory.filter(i => i.quantity < 10);

                const topSelling = useMemo(() => {
                    const stats = {};
                    filteredTransactions.forEach(t => {
                        if (!stats[t.stockName]) stats[t.stockName] = { qty: 0, profit: 0, name: t.stockName };
                        stats[t.stockName].qty += t.quantity;
                        stats[t.stockName].profit += t.profit;
                    });
                    return Object.values(stats).sort((a, b) => b.qty - a.qty).slice(0, 5);
                }, [filteredTransactions]);

                const filterLabels = {
                    'all': 'All Time',
                    'week': 'This Week',
                    'month': 'This Month',
                    'year': 'This Year',
                    'custom': 'Custom Range'
                };

                return (
                    <div className="space-y-6 fade-in">
                        {/* Date Filter Controls */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-stone-200">
                            <div className="flex flex-wrap items-center gap-3">
                                <span className="text-sm font-medium text-stone-600">Filter by:</span>
                                <div className="flex flex-wrap gap-2">
                                    {['all', 'week', 'month', 'year', 'custom'].map(filter => (
                                        <button
                                            key={filter}
                                            onClick={() => setDateFilter(filter)}
                                            className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${dateFilter === filter
                                                ? 'bg-amber-600 text-white'
                                                : 'bg-stone-100 text-stone-600 hover:bg-stone-200'
                                                }`}
                                        >
                                            {filterLabels[filter]}
                                        </button>
                                    ))}
                                </div>
                                {dateFilter === 'custom' && (
                                    <div className="flex gap-2 items-center">
                                        <input
                                            type="date"
                                            className="p-2 border border-stone-300 rounded-lg text-sm"
                                            value={customDateRange.start}
                                            onChange={e => setCustomDateRange({ ...customDateRange, start: e.target.value })}
                                        />
                                        <span className="text-stone-400">to</span>
                                        <input
                                            type="date"
                                            className="p-2 border border-stone-300 rounded-lg text-sm"
                                            value={customDateRange.end}
                                            onChange={e => setCustomDateRange({ ...customDateRange, end: e.target.value })}
                                        />
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                <h3 className="text-stone-500 text-sm font-medium">Total Cost Price</h3>
                                <p className="text-2xl font-bold text-red-600 mt-2">{formatMoney(totalCostPrice)}</p>
                                <p className="text-xs text-stone-400 mt-1">Sum of all purchase costs</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                <h3 className="text-stone-500 text-sm font-medium">Total Revenue</h3>
                                <p className="text-2xl font-bold text-green-700 mt-2">{formatMoney(totalRevenue)}</p>
                                <p className="text-xs text-stone-400 mt-1">Sum of all selling prices</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                <h3 className="text-stone-500 text-sm font-medium">Total Profit</h3>
                                <p className="text-2xl font-bold text-orange-600 mt-2">
                                    {formatMoney(totalProfit)}
                                    <span className="text-sm font-normal text-orange-500 ml-2">({profitMargin}%)</span>
                                </p>
                                <p className="text-xs text-stone-400 mt-1">Revenue - Cost Price (Margin %)</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                <h3 className="text-stone-500 text-sm font-medium">Inventory Value</h3>
                                <p className="text-2xl font-bold text-amber-700 mt-2">{formatMoney(totalStockValue)}</p>
                                <p className="text-xs text-stone-400 mt-1">Current stock worth</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className={`p-6 rounded-xl shadow-sm border border-red-100 ${lowStockItems.length > 0 ? 'bg-red-50' : 'bg-white'}`}>
                                <h3 className="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                                    {Icons.AlertTriangle} Low Stock Alerts
                                </h3>
                                {lowStockItems.length === 0 ? (
                                    <p className="text-stone-500 text-sm">All stock levels are healthy.</p>
                                ) : (
                                    <ul className="space-y-2">
                                        {lowStockItems.map(item => (
                                            <li key={item.id} className="flex justify-between items-center bg-white p-2 rounded border border-red-200">
                                                <span className="font-medium text-red-700">{item.name}</span>
                                                <span className="text-xs font-bold bg-red-200 text-red-800 px-2 py-1 rounded">Qty: {item.quantity}</span>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                <h3 className="text-lg font-bold text-stone-800 mb-4 flex items-center gap-2">
                                    {Icons.TrendingUp} Top Selling Products
                                    {dateFilter !== 'all' && <span className="text-xs font-normal text-stone-400">({filterLabels[dateFilter]})</span>}
                                </h3>
                                {topSelling.length === 0 ? (
                                    <p className="text-stone-500 text-sm">No sales data available yet.</p>
                                ) : (
                                    <ul className="space-y-3">
                                        {topSelling.map((item, idx) => (
                                            <li key={item.name} className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${idx < 3 ? 'bg-amber-100 text-amber-800' : 'bg-stone-100 text-stone-600'}`}>
                                                        {idx + 1}
                                                    </span>
                                                    <span className="font-medium text-stone-700">{item.name}</span>
                                                </div>
                                                <div className="text-right">
                                                    <span className="block font-bold text-stone-800">{item.qty} Sold</span>
                                                    <span className="text-xs text-green-600">+{formatMoney(item.profit)} profit</span>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <h3 className="text-lg font-bold text-stone-800 mb-4">
                                Recent Transactions
                                {dateFilter !== 'all' && <span className="text-sm font-normal text-stone-400 ml-2">({filterLabels[dateFilter]})</span>}
                            </h3>
                            {filteredTransactions.length === 0 ? (
                                <p className="text-stone-400">No transactions yet.</p>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-amber-50 text-amber-900">
                                            <tr>
                                                <th className="px-4 py-3">Date</th>
                                                <th className="px-4 py-3">Item</th>
                                                <th className="px-4 py-3">Dest</th>
                                                <th className="px-4 py-3 text-right">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredTransactions.slice(0, 5).map(t => (
                                                <tr key={t.id} className="border-b border-stone-100 last:border-0 hover:bg-amber-50">
                                                    <td className="px-4 py-3 text-stone-500">{formatDateDisplay(t.date)}</td>
                                                    <td className="px-4 py-3 font-medium text-stone-800">{t.stockName} <span className="text-stone-400 text-xs">x{t.quantity}</span></td>
                                                    <td className="px-4 py-3 text-stone-600">{t.destinationName}</td>
                                                    <td className="px-4 py-3 text-right font-medium text-green-700">{formatMoney(t.totalAmount)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const InventoryView = () => {
                const [form, setForm] = useState({ name: '', quantity: '', costPrice: '', sellingPrice: '' });

                const handleSubmit = (e) => {
                    e.preventDefault(); // Prevent default form submission behavior
                    addStock({
                        name: form.name,
                        quantity: Number(form.quantity),
                        costPrice: Number(form.costPrice),
                        sellingPrice: Number(form.sellingPrice)
                    });
                    setForm({ name: '', quantity: '', costPrice: '', sellingPrice: '' });
                };

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
                        <div className="lg:col-span-1">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200 sticky top-4">
                                <h3 className="text-lg font-bold mb-4 text-stone-800">Add Stock</h3>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-stone-700">Medicine Name</label>
                                        <input required type="text" className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                            value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} placeholder="e.g. Paracetamol" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-stone-700">Quantity</label>
                                        <input required type="number" min="0" className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                            value={form.quantity} onChange={e => setForm({ ...form, quantity: e.target.value })} placeholder="0" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700">Cost Price</label>
                                            <input required type="number" min="0" className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={form.costPrice} onChange={e => setForm({ ...form, costPrice: e.target.value })} placeholder="₹" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700">Selling Price</label>
                                            <input required type="number" min="0" className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={form.sellingPrice} onChange={e => setForm({ ...form, sellingPrice: e.target.value })} placeholder="₹" />
                                        </div>
                                    </div>
                                    <button type="submit" className="w-full bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition font-medium">Add to Inventory</button>
                                </form>
                            </div>
                        </div>
                        <div className="lg:col-span-2">
                            <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                                <div className="p-4 border-b border-stone-200 bg-amber-50 flex justify-between items-center">
                                    <h3 className="font-bold text-amber-900">Current Stock</h3>
                                    <span className="text-xs bg-amber-200 text-amber-900 px-2 py-1 rounded-full">{inventory.length} Items</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-stone-50 text-stone-600">
                                            <tr>
                                                <th className="px-4 py-3">Name</th>
                                                <th className="px-4 py-3">Qty</th>
                                                <th className="px-4 py-3">CP</th>
                                                <th className="px-4 py-3">SP</th>
                                                <th className="px-4 py-3 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {inventory.map(item => (
                                                <tr key={item.id} className="border-b border-stone-100 last:border-0 hover:bg-amber-50">
                                                    <td className="px-4 py-3 font-medium text-stone-800">{item.name}</td>
                                                    <td className={`px-4 py-3 font-bold ${item.quantity < 10 ? 'text-red-500' : 'text-green-700'}`}>{item.quantity}</td>
                                                    <td className="px-4 py-3 text-stone-500">{formatMoney(item.costPrice)}</td>
                                                    <td className="px-4 py-3 text-stone-500">{formatMoney(item.sellingPrice)}</td>
                                                    <td className="px-4 py-3 text-right">
                                                        <button onClick={() => deleteStock(item.id)} className="text-red-400 hover:text-red-600 p-1">
                                                            {Icons.Trash2}
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {inventory.length === 0 && (
                                                <tr><td colSpan="5" className="text-center py-8 text-stone-400">Inventory is empty.</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DestinationsView = () => {
                const [newDest, setNewDest] = useState('');
                const [newLabel, setNewLabel] = useState('');

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 fade-in">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-stone-800">{Icons.MapPin} Destinations</h3>
                            <div className="flex gap-2 mb-4">
                                <input type="text" value={newDest} onChange={e => setNewDest(e.target.value)}
                                    className="flex-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="e.g. Warehouse A" />
                                <button type="button" onClick={() => { addDestination(newDest); setNewDest(''); }}
                                    className="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700">{Icons.Plus}</button>
                            </div>
                            <ul className="space-y-2">
                                {destinations.map(d => (
                                    <li key={d.id} className="flex justify-between items-center p-3 bg-stone-50 rounded-lg border border-stone-100">
                                        <span className="font-medium text-stone-700">{d.name}</span>
                                        <button onClick={() => removeDestination(d.id)} className="text-red-400 hover:text-red-600">{Icons.Trash2}</button>
                                    </li>
                                ))}
                                {destinations.length === 0 && <p className="text-stone-400 text-sm text-center italic">No destinations added.</p>}
                            </ul>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-stone-800">{Icons.Tag} Transaction Labels</h3>
                            <div className="flex gap-2 mb-4">
                                <input type="text" value={newLabel} onChange={e => setNewLabel(e.target.value)}
                                    className="flex-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="e.g. Delivered" />
                                <button type="button" onClick={() => { addLabel(newLabel); setNewLabel(''); }}
                                    className="bg-stone-600 text-white px-4 py-2 rounded-lg hover:bg-stone-700">{Icons.Plus}</button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {labels.map(l => (
                                    <span key={l} className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-amber-100 text-amber-800 border border-amber-200">
                                        {l}
                                        <button onClick={() => removeLabel(l)} className="ml-2 text-amber-600 hover:text-amber-900">&times;</button>
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const TransactionView = () => {
                // Cart State
                const [cart, setCart] = useState([]);
                // Common Form State
                const [commonData, setCommonData] = useState({
                    destinationId: '',
                    label: '',
                    date: new Date().toISOString().split('T')[0]
                });
                // Current Item Input State
                const [currentItem, setCurrentItem] = useState({ stockId: '', quantity: '' });

                const selectedStock = inventory.find(i => i.id === currentItem.stockId);

                // Add Item to Cart
                const addToCart = () => {
                    if (!selectedStock) return showNotification('Please select a medicine', 'error');
                    if (!currentItem.quantity || currentItem.quantity <= 0) return showNotification('Enter valid quantity', 'error');
                    if (selectedStock.quantity < currentItem.quantity) return showNotification('Insufficient stock!', 'error');

                    // Check if already in cart
                    const existingInCart = cart.find(i => i.stockId === currentItem.stockId);
                    if (existingInCart) {
                        return showNotification('Item already in cart, remove it first to update', 'error');
                    }

                    const qty = Number(currentItem.quantity);
                    const totalAmount = selectedStock.sellingPrice * qty;
                    const profit = (selectedStock.sellingPrice - selectedStock.costPrice) * qty;

                    const newItem = {
                        tempId: generateId(),
                        stockId: selectedStock.id,
                        stockName: selectedStock.name,
                        quantity: qty,
                        costPrice: selectedStock.costPrice,
                        sellingPrice: selectedStock.sellingPrice,
                        totalAmount,
                        profit
                    };

                    setCart([...cart, newItem]);
                    setCurrentItem({ stockId: '', quantity: '' }); // Reset item input
                };

                const removeFromCart = (tempId) => {
                    setCart(cart.filter(item => item.tempId !== tempId));
                };

                const cartTotal = cart.reduce((sum, item) => sum + item.totalAmount, 0);

                const handleFinalSubmit = () => {
                    if (cart.length === 0) return showNotification('Cart is empty', 'error');
                    if (!commonData.destinationId) return showNotification('Select a destination', 'error');
                    if (!commonData.label) return showNotification('Select a label', 'error');

                    processCartTransaction(cart, commonData);
                    setCart([]);
                    // commonData date is kept, others reset if needed, but keeping them for bulk entry is usually better UX
                };

                return (
                    <div className="max-w-4xl mx-auto space-y-6 fade-in">

                        {/* 1. Common Details Section */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <h2 className="text-lg font-bold mb-4 text-stone-800 flex items-center gap-2">
                                {Icons.Settings} Transaction Details
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-stone-700 mb-1">Date</label>
                                    <input type="date" className="w-full p-2 border border-stone-300 rounded-lg outline-none focus:ring-2 focus:ring-amber-500"
                                        value={commonData.date} onChange={e => setCommonData({ ...commonData, date: e.target.value })} />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-stone-700 mb-1">Status Label</label>
                                    <select className="w-full p-2 border border-stone-300 rounded-lg outline-none focus:ring-2 focus:ring-amber-500 bg-white"
                                        value={commonData.label} onChange={e => setCommonData({ ...commonData, label: e.target.value })}>
                                        <option value="">Select Status</option>
                                        {labels.map(l => <option key={l} value={l}>{l}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-stone-700 mb-1">Destination</label>
                                    <select className="w-full p-2 border border-stone-300 rounded-lg outline-none focus:ring-2 focus:ring-amber-500 bg-white"
                                        value={commonData.destinationId} onChange={e => setCommonData({ ...commonData, destinationId: e.target.value })}>
                                        <option value="">Select Destination</option>
                                        {destinations.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {/* 2. Add Item Section */}
                            <div className="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-stone-200 h-fit">
                                <h2 className="text-lg font-bold mb-4 text-stone-800 flex items-center gap-2">
                                    {Icons.Plus} Add Item
                                </h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-stone-700 mb-1">Select Medicine</label>
                                        <select className="w-full p-2 border border-stone-300 rounded-lg outline-none focus:ring-2 focus:ring-amber-500 bg-white"
                                            value={currentItem.stockId} onChange={e => setCurrentItem({ ...currentItem, stockId: e.target.value })}>
                                            <option value="">Choose item...</option>
                                            {inventory.map(item => (
                                                <option key={item.id} value={item.id} disabled={item.quantity === 0}>
                                                    {item.name} (Qty: {item.quantity})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-stone-700 mb-1">Quantity</label>
                                        <input type="number" min="1" max={selectedStock?.quantity || 1}
                                            className="w-full p-2 border border-stone-300 rounded-lg outline-none focus:ring-2 focus:ring-amber-500"
                                            value={currentItem.quantity} onChange={e => setCurrentItem({ ...currentItem, quantity: e.target.value })}
                                            placeholder={selectedStock ? `Max: ${selectedStock.quantity}` : ''}
                                        />
                                    </div>
                                    {selectedStock && currentItem.quantity && (
                                        <div className="text-sm bg-amber-50 p-2 rounded border border-amber-100 text-amber-900">
                                            Price: {formatMoney(selectedStock.sellingPrice * currentItem.quantity)}
                                        </div>
                                    )}
                                    <button onClick={addToCart} className="w-full bg-stone-700 text-white py-2 rounded-lg font-medium hover:bg-stone-800 transition">
                                        Add to Cart
                                    </button>
                                </div>
                            </div>

                            {/* 3. Cart Summary Section */}
                            <div className="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col">
                                <h2 className="text-lg font-bold mb-4 text-stone-800 flex items-center gap-2">
                                    {Icons.ShoppingCart} Current Cart
                                </h2>

                                <div className="flex-1 overflow-y-auto min-h-[200px] mb-4">
                                    {cart.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-stone-400 border-2 border-dashed border-stone-200 rounded-lg">
                                            <p>Cart is empty</p>
                                        </div>
                                    ) : (
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-stone-50 text-stone-600 sticky top-0">
                                                <tr>
                                                    <th className="px-3 py-2">Item</th>
                                                    <th className="px-3 py-2 text-right">Qty</th>
                                                    <th className="px-3 py-2 text-right">Price</th>
                                                    <th className="px-3 py-2 text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-stone-100">
                                                {cart.map(item => (
                                                    <tr key={item.tempId}>
                                                        <td className="px-3 py-2 font-medium">{item.stockName}</td>
                                                        <td className="px-3 py-2 text-right">{item.quantity}</td>
                                                        <td className="px-3 py-2 text-right">{formatMoney(item.totalAmount)}</td>
                                                        <td className="px-3 py-2 text-right">
                                                            <button onClick={() => removeFromCart(item.tempId)} className="text-red-500 hover:text-red-700">
                                                                {Icons.X}
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>

                                <div className="border-t border-stone-200 pt-4 flex justify-between items-center bg-stone-50 p-4 rounded-lg">
                                    <div>
                                        <p className="text-stone-500 text-sm">Total Items: {cart.length}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-stone-500 font-bold uppercase">Cart Total</p>
                                        <p className="text-2xl font-bold text-amber-600">{formatMoney(cartTotal)}</p>
                                    </div>
                                </div>
                                <button onClick={handleFinalSubmit} disabled={cart.length === 0}
                                    className={`w-full mt-4 py-3 rounded-lg font-bold shadow-lg transition text-white
                                        ${cart.length === 0 ? 'bg-stone-300 cursor-not-allowed' : 'bg-green-700 hover:bg-green-800 shadow-green-200'}
                                    `}>
                                    Confirm Transaction
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const HistoryView = ({ destinations, setMonthlyReportData, setShowMonthlyReportModal }) => {
                const [filterDate, setFilterDate] = useState('');
                const [searchTerm, setSearchTerm] = useState('');
                const [destinationFilter, setDestinationFilter] = useState('');
                const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' });
                const [editingId, setEditingId] = useState(null);
                const [showMonthlyReportControls, setShowMonthlyReportControls] = useState(false);
                const [monthlyReportForm, setMonthlyReportForm] = useState({ destinationId: '', month: String(new Date().getMonth()), year: String(new Date().getFullYear()) });

                // Edit transaction modal state
                const [editingTransaction, setEditingTransaction] = useState(null);
                const [editForm, setEditForm] = useState({ quantity: '', costPrice: '', sellingPrice: '', label: '', date: '' });

                const years = Array.from({ length: 5 }, (_, i) => String(new Date().getFullYear() - i));
                const months = [
                    { value: '0', label: 'January' }, { value: '1', label: 'February' },
                    { value: '2', label: 'March' }, { value: '3', label: 'April' },
                    { value: '4', label: 'May' }, { value: '5', label: 'June' },
                    { value: '6', label: 'July' }, { value: '7', label: 'August' },
                    { value: '8', label: 'September' }, { value: '9', label: 'October' },
                    { value: '10', label: 'November' }, { value: '11', label: 'December' },
                ];

                const filtered = transactions.filter(t => {
                    const matchesDate = filterDate ? t.date.startsWith(filterDate) : true;
                    const matchesSearch = t.stockName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        t.destinationName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        t.label.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesDestination = destinationFilter ? t.destinationId === destinationFilter : true;
                    return matchesDate && matchesSearch && matchesDestination;
                });

                const sorted = [...filtered].sort((a, b) => {
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];
                    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                    if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                const totals = useMemo(() => {
                    return sorted.reduce((acc, t) => {
                        acc.totalCostPrice += t.costPrice * t.quantity;
                        acc.totalSellingPrice += t.sellingPrice * t.quantity;
                        acc.totalProfit += t.profit;
                        return acc;
                    }, { totalCostPrice: 0, totalSellingPrice: 0, totalProfit: 0 });
                }, [sorted]);

                const handleSort = (key) => {
                    let direction = 'asc';
                    if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                    setSortConfig({ key, direction });
                };

                const SortHeader = ({ label, sortKey, align = 'left' }) => (
                    <th className={`px-6 py-3 cursor-pointer hover:bg-amber-100 transition select-none text-${align}`} onClick={() => handleSort(sortKey)}>
                        <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : ''}`}>
                            {label}
                            {sortConfig.key === sortKey && <span className="text-amber-600">{sortConfig.direction === 'asc' ? '↑' : '↓'}</span>}
                        </div>
                    </th>
                );

                const handleStatusChange = (t, newLabel) => {
                    if (newLabel === t.label) { setEditingId(null); return; }
                    if (confirm(`Change status from "${t.label}" to "${newLabel}"?`)) updateTransactionStatus(t.id, newLabel);
                    setEditingId(null);
                };

                // Populate edit form when editing transaction changes
                useEffect(() => {
                    if (editingTransaction) {
                        setEditForm({
                            quantity: editingTransaction.quantity,
                            costPrice: editingTransaction.costPrice,
                            sellingPrice: editingTransaction.sellingPrice,
                            label: editingTransaction.label,
                            date: editingTransaction.date.split('T')[0]
                        });
                    }
                }, [editingTransaction]);

                const handleEditSubmit = (e) => {
                    e.preventDefault();
                    if (!editingTransaction) return;

                    const stockItem = inventory.find(i => i.id === editingTransaction.stockId);
                    const maxQty = stockItem ? stockItem.quantity + editingTransaction.quantity : editingTransaction.quantity;

                    if (Number(editForm.quantity) > maxQty) {
                        alert(`Cannot set quantity to ${editForm.quantity}. Maximum available: ${maxQty}`);
                        return;
                    }

                    updateTransaction(editingTransaction.id, {
                        quantity: Number(editForm.quantity),
                        costPrice: Number(editForm.costPrice),
                        sellingPrice: Number(editForm.sellingPrice),
                        label: editForm.label,
                        date: editForm.date
                    });
                    setEditingTransaction(null);
                };

                // Edit Transaction Modal
                const EditTransactionModal = () => {
                    if (!editingTransaction) return null;

                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                            <div className="bg-white w-full max-w-md p-6 rounded-xl shadow-xl">
                                <h3 className="text-lg font-bold text-stone-800 mb-4">Edit Transaction</h3>
                                <p className="text-sm text-stone-500 mb-4">Editing: <span className="font-medium text-stone-700">{editingTransaction.stockName}</span></p>

                                <form onSubmit={handleEditSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700 mb-1">Quantity</label>
                                            <input type="number" min="1" required
                                                className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={editForm.quantity}
                                                onChange={e => setEditForm({ ...editForm, quantity: e.target.value })}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700 mb-1">Date</label>
                                            <input type="date" required
                                                className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={editForm.date}
                                                onChange={e => setEditForm({ ...editForm, date: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700 mb-1">Cost Price (₹)</label>
                                            <input type="number" min="0" step="0.01" required
                                                className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={editForm.costPrice}
                                                onChange={e => setEditForm({ ...editForm, costPrice: e.target.value })}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700 mb-1">Selling Price (₹)</label>
                                            <input type="number" min="0" step="0.01" required
                                                className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={editForm.sellingPrice}
                                                onChange={e => setEditForm({ ...editForm, sellingPrice: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-stone-700 mb-1">Status</label>
                                        <select
                                            className="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-white"
                                            value={editForm.label}
                                            onChange={e => setEditForm({ ...editForm, label: e.target.value })}
                                        >
                                            {labels.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>

                                    {editForm.quantity && editForm.sellingPrice && (
                                        <div className="bg-stone-50 p-3 rounded-lg text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-stone-500">New Total:</span>
                                                <span className="font-bold text-stone-800">{formatMoney(editForm.quantity * editForm.sellingPrice)}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-stone-500">New Profit:</span>
                                                <span className="font-bold text-green-600">{formatMoney((editForm.sellingPrice - editForm.costPrice) * editForm.quantity)}</span>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setEditingTransaction(null)}
                                            className="flex-1 py-2 rounded-lg border border-stone-300 text-stone-700 hover:bg-stone-50 transition">
                                            Cancel
                                        </button>
                                        <button type="submit"
                                            className="flex-1 py-2 rounded-lg bg-amber-600 text-white font-medium hover:bg-amber-700 transition">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    );
                };

                return (
                    <>
                        <EditTransactionModal />
                        <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden fade-in">
                            <div className="p-4 border-b border-stone-200 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                                <h3 className="font-bold text-lg text-stone-800">Transaction History</h3>
                                <div className="flex flex-col md:flex-row gap-2 w-full lg:w-auto">
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <input type="date" className="p-2 border border-stone-300 rounded-lg text-sm flex-1 md:w-auto"
                                            value={filterDate} onChange={e => setFilterDate(e.target.value)} />
                                        <select className="p-2 border border-stone-300 rounded-lg text-sm flex-1 md:w-40"
                                            value={destinationFilter} onChange={e => setDestinationFilter(e.target.value)}>
                                            <option value="">All Destinations</option>
                                            {destinations.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <input type="text" placeholder="Search..." className="p-2 border border-stone-300 rounded-lg text-sm flex-1 md:w-48"
                                            value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        <button onClick={() => setShowMonthlyReportControls(!showMonthlyReportControls)} className="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg hover:bg-stone-300 transition flex items-center justify-center gap-2 whitespace-nowrap">
                                            {Icons.Printer} Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {showMonthlyReportControls && (
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200 mb-6 fade-in">
                                    <h3 className="text-lg font-bold mb-4 text-stone-800 flex items-center gap-2">
                                        Generate Monthly Report
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700">Destination</label>
                                            <select className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={monthlyReportForm.destinationId} onChange={e => setMonthlyReportForm({ ...monthlyReportForm, destinationId: e.target.value })}>
                                                <option value="">Select Destination</option>
                                                {destinations.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700">Month</label>
                                            <select className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={monthlyReportForm.month} onChange={e => setMonthlyReportForm({ ...monthlyReportForm, month: e.target.value })}>
                                                {months.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-stone-700">Year</label>
                                            <select className="w-full mt-1 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={monthlyReportForm.year} onChange={e => setMonthlyReportForm({ ...monthlyReportForm, year: e.target.value })}>
                                                {years.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <button onClick={() => {
                                        if (!monthlyReportForm.destinationId) {
                                            alert('Please select a destination for the monthly report.');
                                            return;
                                        }
                                        setMonthlyReportData(monthlyReportForm);
                                        setShowMonthlyReportModal(true);
                                    }} className="w-full bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition font-medium">
                                        Generate Report
                                    </button>
                                </div>
                            )}
                            <div className="overflow-x-auto min-h-[400px]">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-amber-50 text-amber-900 uppercase text-xs tracking-wider">
                                        <tr>
                                            <SortHeader label="Status" sortKey="label" />
                                            <SortHeader label="Date" sortKey="date" />
                                            <SortHeader label="Medicine" sortKey="stockName" />
                                            <SortHeader label="Destination" sortKey="destinationName" />
                                            <SortHeader label="Qty" sortKey="quantity" />
                                            <SortHeader label="CP" sortKey="costPrice" align="right" />
                                            <SortHeader label="Total" sortKey="totalAmount" align="right" />
                                            <th className="px-6 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-stone-100">
                                        {sorted.map(t => (
                                            <tr key={t.id} className="hover:bg-amber-50 transition group">
                                                <td className="px-6 py-4">
                                                    {editingId === t.id ? (
                                                        <select autoFocus className="p-1 border rounded text-xs" defaultValue={t.label} onBlur={() => setEditingId(null)} onChange={(e) => handleStatusChange(t, e.target.value)}>
                                                            {labels.map(l => <option key={l} value={l}>{l}</option>)}
                                                        </select>
                                                    ) : (
                                                        <button onClick={() => setEditingId(t.id)} className="px-2 py-1 rounded text-xs font-bold bg-stone-100 text-stone-700 hover:bg-stone-200 transition flex items-center gap-1">
                                                            {t.label} <span className="opacity-0 group-hover:opacity-50 text-[10px]">✎</span>
                                                        </button>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-stone-500">{formatDateDisplay(t.date)}</td>
                                                <td className="px-6 py-4 font-medium text-stone-800">{t.stockName}</td>
                                                <td className="px-6 py-4 text-stone-600">{t.destinationName}</td>
                                                <td className="px-6 py-4 text-stone-600">{t.quantity}</td>
                                                <td className="px-6 py-4 text-right text-stone-500">{formatMoney(t.costPrice * t.quantity)}</td>
                                                <td className="px-6 py-4 text-right font-bold text-stone-800">{formatMoney(t.totalAmount)}</td>
                                                <td className="px-6 py-4 text-right flex items-center justify-end gap-2">
                                                    <button onClick={() => setEditingTransaction(t)} className="text-stone-400 hover:text-blue-600 transition" title="Edit Transaction">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                                                    </button>
                                                    <button onClick={() => {
                                                        if (confirm(`Delete transaction for ${t.stockName}? This will restore ${t.quantity} units to inventory.`)) {
                                                            deleteTransaction(t.id);
                                                        }
                                                    }} className="text-stone-400 hover:text-red-600 transition" title="Delete Transaction">
                                                        {Icons.Trash2}
                                                    </button>
                                                    <button onClick={() => setPrintInvoiceId(t.invoiceId)} className="text-stone-400 hover:text-amber-600 transition" title="Print Invoice">
                                                        {Icons.Printer}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                        {sorted.length === 0 && <tr><td colSpan="7" className="text-center py-8 text-stone-400">No records found.</td></tr>}
                                    </tbody>
                                    <tfoot>
                                        <tr className="bg-amber-100 text-amber-900 font-bold">
                                            <td colSpan="5" className="px-6 py-3 text-right">Totals:</td>
                                            <td className="px-6 py-3 text-right">{formatMoney(totals.totalCostPrice)}</td>
                                            <td className="px-6 py-3 text-right">{formatMoney(totals.totalSellingPrice)}</td>
                                            <td className="px-6 py-3 text-right text-green-700">{formatMoney(totals.totalProfit)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </>
                );
            };

            const SettingsView = () => (
                <div className="max-w-xl mx-auto space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-stone-800">{Icons.Download} Data Management</h3>

                        <div className="space-y-4">
                            <button onClick={exportData} className="flex items-center justify-center gap-2 w-full bg-amber-600 text-white py-3 rounded-lg hover:bg-amber-700 transition">
                                {Icons.Download} Export Data to JSON
                            </button>

                            <div className="relative border-2 border-dashed border-stone-300 rounded-lg p-6 text-center hover:bg-stone-50 transition group">
                                <input type="file" accept=".json" onChange={importData} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                <div className="flex flex-col items-center justify-center text-stone-500 group-hover:text-amber-600">
                                    {Icons.Upload}
                                    <span className="mt-2 text-sm font-medium">Click to Import JSON</span>
                                </div>
                            </div>
                        </div>

                        <h3 className="text-lg font-bold mt-8 mb-4 flex items-center gap-2 text-red-800">{Icons.Trash2} Danger Zone</h3>
                        <div className="space-y-3">
                            <button onClick={() => clearData('Inventory')} className="w-full border border-red-200 text-red-700 py-2 rounded-lg hover:bg-red-50 transition text-sm">Clear Inventory Only</button>
                            <button onClick={() => clearData('History')} className="w-full border border-red-200 text-red-700 py-2 rounded-lg hover:bg-red-50 transition text-sm">Clear Transaction History</button>
                            <button onClick={() => clearData('Everything')} className="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition text-sm font-bold">Full Factory Reset (Clear All)</button>
                        </div>
                    </div>
                </div>
            );

            // --- Layout ---
            const NavItem = ({ id, icon, label, onClick }) => (
                <button
                    onClick={() => {
                        setView(id);
                        if (onClick) onClick();
                    }}
                    className={`flex items-center gap-3 w-full px-4 py-3 rounded-lg text-sm font-medium transition-colors ${view === id ? 'bg-amber-100 text-amber-800' : 'text-stone-600 hover:bg-stone-200'}`}
                >
                    {icon}
                    <span>{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-stone-100">
                    <InvoiceModal invoiceId={printInvoiceId} onClose={() => setPrintInvoiceId(null)} />
                    {showMonthlyReportModal && (
                        <MonthlyReportModal
                            show={showMonthlyReportModal}
                            onClose={() => setShowMonthlyReportModal(false)}
                            destinationId={monthlyReportData.destinationId}
                            month={monthlyReportData.month}
                            year={monthlyReportData.year}
                        />
                    )}
                    {notification && (
                        <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate-bounce flex items-center gap-3 ${notification.type === 'error' ? 'bg-red-500' : notification.type === 'neutral' ? 'bg-stone-700' : 'bg-stone-800'}`}>
                            <span>{notification.msg}</span>
                            {notification.undoAction && (
                                <button onClick={() => { notification.undoAction(); setNotification(null); }} className="bg-white text-stone-800 text-xs px-2 py-1 rounded hover:bg-stone-200 uppercase font-bold">Undo</button>
                            )}
                        </div>
                    )}

                    {/* Mobile Menu Button */}
                    <div className="md:hidden bg-white border-b border-stone-200 p-4 flex justify-between items-center no-print">
                        <div className="font-bold text-stone-800 flex items-center gap-2">
                            <span className="bg-amber-600 text-white p-1 rounded">MS</span> MedStock
                        </div>
                        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="text-stone-600 hover:text-amber-600">
                            {Icons.Menu}
                        </button>
                    </div>

                    {/* Sidebar: Flex-col on desktop, togglable on mobile */}
                    <aside className={`
                        bg-white border-r border-stone-200 flex-shrink-0 no-print
                        md:w-64 md:flex md:flex-col
                        ${isMobileMenuOpen ? 'block' : 'hidden md:flex'}
                    `}>
                        <div className="p-6 border-b border-stone-200 hidden md:block">
                            <h1 className="text-xl font-bold text-stone-800 flex items-center gap-2">
                                <span className="bg-amber-600 text-white p-1 rounded">MS</span> MedStock
                            </h1>
                        </div>
                        <nav className="p-4 space-y-1">
                            <NavItem id="dashboard" icon={Icons.LayoutDashboard} label="Dashboard" onClick={() => setIsMobileMenuOpen(false)} />
                            <NavItem id="inventory" icon={Icons.Package} label="Inventory" onClick={() => setIsMobileMenuOpen(false)} />
                            <NavItem id="destinations" icon={Icons.MapPin} label="Destinations" onClick={() => setIsMobileMenuOpen(false)} />
                            <NavItem id="transaction" icon={Icons.ShoppingCart} label="New Transaction" onClick={() => setIsMobileMenuOpen(false)} />
                            <NavItem id="history" icon={Icons.History} label="History Log" onClick={() => setIsMobileMenuOpen(false)} />
                            <div className="pt-4 mt-4 border-t border-stone-200">
                                <NavItem id="settings" icon={Icons.Settings} label="Settings" onClick={() => setIsMobileMenuOpen(false)} />
                            </div>
                        </nav>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 overflow-y-auto no-print">
                        <header className="mb-8 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-stone-800 capitalize">{view.replace('-', ' ')}</h2>
                                <p className="text-stone-500 text-sm">Manage your medical stock efficiently.</p>
                            </div>
                            <div className="text-sm text-stone-500 bg-white px-3 py-1 rounded-full border border-stone-200 shadow-sm hidden md:block">
                                {formatDateDisplay(new Date().toISOString())}
                            </div>
                        </header>
                        {view === 'dashboard' && <Dashboard />}
                        {view === 'inventory' && <InventoryView />}
                        {view === 'destinations' && <DestinationsView />}
                        {view === 'transaction' && <TransactionView />}
                        {view === 'history' && <HistoryView destinations={destinations} setMonthlyReportData={setMonthlyReportData} setShowMonthlyReportModal={setShowMonthlyReportModal} />}
                        {view === 'settings' && <SettingsView />}
                    </main>
                </div>
            );
        }

        // --- Export/Import Helper Functions (moved outside App to be accessible if needed) ---
        // Note: In this single file structure, they are inside App scope due to state dependency.
        // We redefine duplicates here just for reference or if external usage was needed, but logic is inside App.
        const importData = (e) => document.querySelector('input[type=file]').click();
        const exportData = () => { };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>